<!--/////////////////////////////////////////////////-->
<!--//PAGE FOR THE DCA CLIENT EXTENSION IN LNBITS/////-->
<!--/////////////////////////////////////////////////-->

{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block scripts %} {{ window_vars(user) }}
<script src="{{ static_url_for('satmachineclient/static', path='js/index.js') }}"></script>
{% endblock %} {% block page %}
<div class="row q-col-gutter-md" id="dcaClient">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">
    
    <!-- Loading State -->
    <q-card v-if="loading">
      <q-card-section class="text-center">
        <q-spinner size="2em" />
        <div class="q-mt-md">Loading your DCA dashboard...</div>
      </q-card-section>
    </q-card>

    <!-- Error State -->
    <q-card v-if="error && !loading" class="bg-negative text-white">
      <q-card-section>
        <q-icon name="error" class="q-mr-sm" />
        ${error}
      </q-card-section>
    </q-card>

    <!-- Dashboard Content -->
    <div v-if="hasData">
      <!-- Summary Cards -->
      <q-card class="q-mb-md">
        <q-card-section>
          <h6 class="text-subtitle1 q-my-none q-mb-md">DCA Overview</h6>
          <div class="row q-col-gutter-md">
            <div class="col-6 col-md-3">
              <div class="text-center">
                <div class="text-h6">${formatSats(dashboardData.total_sats_accumulated)}</div>
                <div class="text-grey text-caption">Total Sats</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center">
                <div class="text-h6">${formatCurrency(dashboardData.total_fiat_invested)}</div>
                <div class="text-grey text-caption">Total Invested</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center">
                <div class="text-h6">${formatCurrency(dashboardData.current_fiat_balance)}</div>
                <div class="text-grey text-caption">Available Balance</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-center">
                <div class="text-h6">${dashboardData.total_transactions}</div>
                <div class="text-grey text-caption">Transactions</div>
              </div>
            </div>
          </div>
          <!-- Fiat Value Toggle Button -->
          <div class="row q-mt-sm">
            <div class="col-12 text-center">
              <q-btn 
                flat 
                dense
                :color="showFiatValues ? 'orange' : 'grey'"
                :icon="showFiatValues ? 'visibility_off' : 'attach_money'"
                @click="showFiatValues = !showFiatValues"
              >
                ${showFiatValues ? 'Hide' : 'Show'} Fiat Values
              </q-btn>
            </div>
          </div>

          <!-- Current Value Row (Conditional) -->
          <div v-if="showFiatValues" class="row q-col-gutter-md q-mt-sm">
            <div class="col-12 col-md-6">
              <q-card flat class="bg-orange-1">
                <q-card-section class="text-center">
                  <div class="text-h5 text-orange-8">${formatCurrencyWithCode(dashboardData.current_sats_fiat_value, dashboardData.currency)}</div>
                  <div class="text-caption text-orange-7">Current Value of Bitcoin Holdings</div>
                  <div class="text-caption text-grey">at today's ${dashboardData.currency} exchange rate</div>
                </q-card-section>
              </q-card>
            </div>
            <div class="col-12 col-md-6">
              <q-card flat :class="(dashboardData.current_sats_fiat_value + dashboardData.current_fiat_balance) > dashboardData.total_fiat_invested ? 'bg-green-1' : 'bg-red-1'">
                <q-card-section class="text-center">
                  <div class="text-h6" :class="(dashboardData.current_sats_fiat_value + dashboardData.current_fiat_balance) > dashboardData.total_fiat_invested ? 'text-green-8' : 'text-red-8'">
                    ${(dashboardData.current_sats_fiat_value + dashboardData.current_fiat_balance) > dashboardData.total_fiat_invested ? '+' : ''}
                    ${formatCurrencyWithCode((dashboardData.current_sats_fiat_value + dashboardData.current_fiat_balance) - dashboardData.total_fiat_invested, dashboardData.currency)}
                  </div>
                  <div class="text-caption" :class="(dashboardData.current_sats_fiat_value + dashboardData.current_fiat_balance) > dashboardData.total_fiat_invested ? 'text-green-7' : 'text-red-7'">
                    ${(dashboardData.current_sats_fiat_value + dashboardData.current_fiat_balance) > dashboardData.total_fiat_invested ? 'Bitcoin Appreciation vs Fiat' : 'Fiat Depreciation vs Bitcoin'}
                  </div>
                  <div class="text-caption text-grey">vs total invested</div>
                </q-card-section>
              </q-card>
            </div>
          </div>
          <!-- Pending Deposits Row -->
          <div v-if="dashboardData.pending_fiat_deposits > 0" class="row q-col-gutter-md q-mt-sm">
            <div class="col-12">
              <q-banner inline-actions class="bg-orange-1 text-orange-9">
                <template v-slot:avatar>
                  <q-icon name="schedule" color="orange" />
                </template>
                <div class="text-subtitle2">
                  <strong>${formatCurrency(dashboardData.pending_fiat_deposits)}</strong> pending deposit
                </div>
                <div class="text-caption">
                  Cash waiting to be inserted into ATM for DCA processing
                </div>
              </q-banner>
            </div>
          </div>
        </q-card-section>
      </q-card>

      <!-- DCA Status -->
      <q-card class="q-mb-md">
        <q-card-section>
          <h6 class="text-subtitle2 q-my-none q-mb-md">DCA Status</h6>
          <div class="row q-col-gutter-md">
            <div class="col-6">
              <div class="text-body2">Mode: <strong>${dashboardData.dca_mode}</strong></div>
            </div>
            <div class="col-6">
              <div class="text-body2">Status: 
                <q-chip 
                  :color="dashboardData.dca_status === 'active' ? 'positive' : 'warning'"
                  text-color="white"
                  size="sm"
                >
                  ${dashboardData.dca_status}
                </q-chip>
              </div>
            </div>
          </div>
          <div v-if="dashboardData.average_cost_basis > 0" class="q-mt-md">
            <div class="text-body2">Average Cost Basis: <strong>${Math.round(dashboardData.average_cost_basis)} sats/GTQ</strong></div>
          </div>
        </q-card-section>
      </q-card>

      <!-- Recent Transactions -->
      <q-card>
        <q-card-section>
          <h6 class="text-subtitle2 q-my-none q-mb-md">Recent Transactions</h6>
          <div v-if="transactions.length === 0" class="text-grey text-center q-pa-md">
            No transactions yet
          </div>
          <q-list v-else>
            <q-item v-for="tx in transactions" :key="tx.id">
              <q-item-section>
                <q-item-label>${formatSats(tx.amount_sats)}</q-item-label>
                <q-item-label caption>${formatCurrency(tx.amount_fiat)} â€¢ ${formatDate(tx.transaction_time || tx.created_at)}</q-item-label>
              </q-item-section>
              <q-item-section side>
                <q-chip 
                  :color="tx.status === 'confirmed' ? 'positive' : 'warning'"
                  text-color="white"
                  size="sm"
                >
                  ${tx.status}
                </q-chip>
              </q-item-section>
            </q-item>
          </q-list>
        </q-card-section>
      </q-card>
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">
          {{SITE_TITLE}} DCA Client
        </h6>
        <p>
          Monitor your Dollar Cost Averaging progress and manage your DCA settings.
        </p>
      </q-card-section>
      <q-card-section class="q-pa-none">
        <q-separator></q-separator>
        <q-list>
          <q-expansion-item
            group="info"
            icon="account_balance_wallet"
            label="Quick Stats"
            :content-inset-level="0.5"
          >
            <q-card-section class="text-caption" v-if="dashboardData">
              <div class="row">
                <div class="col-6">DCA Mode:</div>
                <div class="col-6">${ dashboardData.dca_mode }</div>
              </div>
              <div class="row">
                <div class="col-6">Status:</div>
                <div class="col-6">${ dashboardData.dca_status }</div>
              </div>
              <div class="row" v-if="dashboardData.average_cost_basis > 0">
                <div class="col-6">Avg Cost:</div>
                <div class="col-6">${ Math.round(dashboardData.average_cost_basis) } sats/GTQ</div>
              </div>
            </q-card-section>
          </q-expansion-item>
        </q-list>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}
